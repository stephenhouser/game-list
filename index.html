<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>Board Game History</title>
		<meta name="author" content="Stephen Houser">
		<meta content="Display games owned or played from BoardGameGeek export" />

		<script type="text/javascript" src="https://code.jquery.com/jquery-3.2.0.min.js"></script>

		<script type="text/javascript" src="https://cdn.datatables.net/1.10.13/js/jquery.dataTables.min.js"></script>
		<link rel="stylesheet" href="https://cdn.datatables.net/1.10.13/css/jquery.dataTables.min.css">

		<!-- Bootstrap Tables -->
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/bootstrap-table.min.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.11.1/locale/bootstrap-table-zh-CN.min.js"></script>

		<!-- Bootstrep 5 -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>


		<link href="https://stephenhouser.com/css/main.css" rel="stylesheet">

		<style>
			.container {
				margin-top: 1em;
			}

			.active {
				text-decoration: none;
			}

			.indent {
				width: 90%;
				margin-left: auto;
				margin-right: auto;
			}
		</style>
	</head>
	<body>
	<nav class="navbar navbar-expand-lg navbar-light" style="background-color: lightgray;">
		<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
			<svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
			<span class="fs-4">The Game Room</span>
		</a>
		<ul class="nav nav-pills">
			<li class="nav-item"><a data-bs-toggle="tab" href="#history" class="nav-link active" aria-current="page">History</a></li>
			<li class="nav-item"><a data-bs-toggle="tab" href="#games" class="nav-link">Games</a></li>
			<li class="nav-item"><a data-bs-toggle="tab" href="#about" class="nav-link">About</a></li>
		</ul>
		<svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
	</nav>
	
	<div class="container">
		<div class="tab-content">
			<div id="history" class="tab-pane fade show active" role="tabpanel">
				<h2>Play History</h2>
				<p>a list of all the games we have played...</p>

				<table id="play-list" class="display" cellspacing="0" width="100%">
					<thead>
						<tr>
							<th>Date</th>
							<th width="10%"></th>
							<th>Game</th>
							<th>Players</th>
							<th>Location</th>
							<th>Comments</th>
						</tr>
					</thead>
					<tfoot>
						<tr>
							<th>Date</th>
							<th width="10%"></th>
							<th>Game</th>
							<th>Players</th>
							<th>Location</th>
							<th>Comments</th>
						</tr>
					</tfoot>
				</table>
			</div>

			<div id="games" class="tab-pane fade" role="tabpanel">
				<h2>Game List</h2>

				<table id="game-list" class="display" cellspacing="0" width="100%">
					<thead>
						<tr>
							<th width="10%"></th>
							<th>Game</th>
							<th>Year</th>
							<th>Plays</th>
							<th>Comments</th>
						</tr>
					</thead>
					<tfoot>
						<tr>
							<th width="10%"></th>
							<th>Game</th>
							<th>Year</th>
							<th>Plays</th>
							<th>Comments</th>
	
						</tr>
					</tfoot>
				</table>
			</div>

			<div id="about" class="tab-pane fade" role="tabpanel">
				<h2>About...</h2>
			</div>

		</div>

		<footer class='footer'>
			<hr />
			<p class='pull-right'><a href='https://github.com/stephenhouser/game-room'>game-room</a> by <a href='http://stephenhouser.com'>Stephen Houser</a></p>				
		</footer>
	</div>

		
		<script type="text/javascript">
			const BGG_USER = '0xACE';

			function parsePlaysXML(xml) {
				const plays = [];
				const playsXML = (new window.DOMParser() ).parseFromString(xml, "text/xml");
				playsXML.querySelectorAll('play').forEach(function(play) {					
					let players = [];
					play.querySelectorAll('player').forEach(function(player) {
						let name = player.getAttribute('name');
						if (name !== 'Anonymous player') {
							players.push(name.split(' ')[0]);
						}
					});

					let comments = '';
					if (play.querySelector('comments')) {
						comments = play.querySelector('comments').textContent;
					}

					const p_json = {
						'bgg_id': play.querySelector('item').getAttribute('objectid'),
						'name': play.querySelector('item').getAttribute('name'),
						'date': play.getAttribute('date'),
						'players': players.join(', '),
						'comments': comments,
						'location': play.getAttribute('location')
					};
					plays.push(p_json);
				});

				return plays;
			}

			function parseGamesXML(xml) {
				const games = [];
				const gamesXML = (new window.DOMParser() ).parseFromString(xml, "text/xml");
				gamesXML.querySelectorAll('item').forEach(function(game) {							
					let comments = '';
					if (game.querySelector('comments')) {
						comments = game.querySelector('comments').textContent;
					}
			
					const p_game = {
						'bgg_id': game.getAttribute('objectid'),
						'name': game.querySelector('name').textContent,
						'image': game.querySelector('image').textContent,
						'year': game.querySelector('yearpublished').textContent,
						'plays': game.querySelector('numplays').textContent,
						'comments': comments
					};

					games.push(p_game);
				});

				return games;
			}

			function bgg_uri(game) {
				return "https://boardgamegeek.com/boardgame/" + game.bgg_id;
			}

			function bgg_image(game) {
				return "";
			}

			function render_date(the_date) {
				const d = new Date(the_date + "T00:00:00");
				// let options = { year: 'numeric', month: 'numeric', day: 'numeric', weekday: 'long',  };
				return the_date + ' '
					+ d.toLocaleDateString('en-US', { weekday: 'long'} ); 
			}

			$(document).ready(function() {
				$('#play-list').DataTable( {
					"ajax": {
						"url": `https://boardgamegeek.com/xmlapi2/plays\?username\=${BGG_USER}`,
						"dataType": "text",
						"dataSrc": function(xml) {
							return parsePlaysXML(xml);
						}
					},
					"paging": false,
					"order": [[0, "desc"]],
					"columns": [
						{ "data": "date" },
						{ "data": null, "width": "12%", "defaultContent": "", "orderable": false },
						{ "data": "name" },
						{ "data": "players", "defaultContent": "" },
						{ "data": "location" },
						{ "data": "comments", "defaultContent": "", "width": "25%" }
					],
					"columnDefs": [
						{	
							"targets": 0,
							"render": function(data, type, row) {
								return render_date(data);
							}
						},
						{	
							"targets": 1,
							"render": function(data, type, row) {
								return "<a href='" + bgg_uri(row) + "' target='_blank'>"
									+ "<img  src='" + bgg_image(row) + "' />"
									+ "</a>";
							}
						},
						{
							"targets": 2,
							"render": function (data, type, row) {
								return "<a href='" + bgg_uri(row) + "' target='_blank'>" + data + "</a>";
							}
						}
					]
				});

				$('#game-list').DataTable( {
					"ajax": {
						"url": `https://boardgamegeek.com/xmlapi2/collection\?username\=${BGG_USER}`,
						"dataType": "text",
						"dataSrc": function(xml) {
							return parseGamesXML(xml);
						}
					},
					"paging": false,
					"order": [[0, "desc"]],
					"columns": [
						{ "data": "image", "width": "12%", "defaultContent": "", "orderable": false },
						{ "data": "name" },
						{ "data": "year", "defaultContent": "" },
						{ "data": "plays" },
						{ "data": "comments", "defaultContent": "", "width": "25%" }
					],
					"columnDefs": [
						{	
							"targets": 0,
							"render": function(data, type, row) {
								return "<a href='" + bgg_uri(row) + "' target='_blank'>"
									+ "<img  src='" + data + "' />"
									+ "</a>";
							}
						},
						{
							"targets": 1,
							"render": function (data, type, row) {
								return "<a href='" + bgg_uri(row) + "' target='_blank'>" + data + "</a>";
							}
						}
					]
				});


			});
		</script>
	</body>
</html>
